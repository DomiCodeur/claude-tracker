#!/bin/bash

# Claude Code Session Tracker
# Real-time monitoring of Claude Code session usage

show_tracking() {
    # Get the directory where this script is located
    SCRIPT_DIR="$(dirname "$(realpath "$0")")"
    SESSION_DATA=$(python3 "$SCRIPT_DIR/calculate_session_tokens.py" 2>/dev/null)
    if [ $? -ne 0 ] || [ -z "$SESSION_DATA" ]; then
        printf "\r‚ùå Error reading session data"
        return 1
    fi
    
    IFS='|' read -r INPUT_TOKENS OUTPUT_TOKENS TOTAL_TOKENS RESET_INFO <<< "$SESSION_DATA"
    CURRENT=$((INPUT_TOKENS + OUTPUT_TOKENS))
    PERCENTAGE=$((CURRENT * 100 / 70000))
    
    # Progress bar (25 chars)
    FILLED=$((CURRENT * 25 / 70000))
    if [ $FILLED -gt 25 ]; then FILLED=25; fi
    EMPTY=$((25 - FILLED))
    
    BAR=""
    for ((i=0; i<FILLED; i++)); do BAR+="‚ñà"; done
    for ((i=0; i<EMPTY; i++)); do BAR+="‚ñë"; done
    
    printf "\rüìä [%s] %s/%s (%s%%) | Reset in %s" "$BAR" "$CURRENT" "70000" "$PERCENTAGE" "$RESET_INFO"
}

trap 'echo -e "\nTracking stopped."; exit 0' INT

while true; do
    show_tracking
    sleep 3
done